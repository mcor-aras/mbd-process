<AML>
 <Item type="SQL" id="6EE82F2037FC4303BAC7FEF4D7916284" action="add">
  <execution_count>7</execution_count>
  <execution_flag>immediate</execution_flag>
  <old_name>z_GetSubSystemTreeData</old_name>
  <sqlserver_body><![CDATA[CREATE PROCEDURE z_GetSubSystemTreeData(
	@MODEL_ID CHAR(32)) AS
BEGIN
	DECLARE @taraget TABLE
	(
		id CHAR(32) COLLATE database_default,
		z_index_no NVARCHAR(32) COLLATE database_default,
		z_parent_subsystem NVARCHAR(32) COLLATE database_default,
		z_subsystem_name NVARCHAR(32) COLLATE database_default,
		z_image_file NVARCHAR(32) COLLATE database_default
	)
	INSERT INTO @taraget
	SELECT
		[id]
		,[Z_INDEX_NO]
		,[Z_PARENT_SUBSYSTEM]
		,[Z_SUBSYSTEM_NAME]
		,[Z_IMAGE_FILE]
	FROM
		INNOVATOR.Z_DRAFTMODEL_SUBSYSTEM
	WHERE SOURCE_ID = @MODEL_ID
 	BEGIN
	  with
		subsystem as (
		  select
		   b.[id]
		   ,b.[Z_INDEX_NO]
		   ,b.[Z_PARENT_SUBSYSTEM]
		   ,b.[Z_SUBSYSTEM_NAME]
		   ,b.[Z_IMAGE_FILE]
		  ,cast(b.[Z_SUBSYSTEM_NAME]  as nvarchar(4000)) as [root] 
		  ,1 as [level]
		  from @taraget b
		  where
			[Z_INDEX_NO] ='1'		  union all
		  select
		   b.[id]
		   ,b.[Z_INDEX_NO]
		   ,b.[Z_PARENT_SUBSYSTEM]
		   ,b.[Z_SUBSYSTEM_NAME]
		   ,b.[Z_IMAGE_FILE]
		   ,[root] + N'/' + b.[Z_SUBSYSTEM_NAME]
           ,[level] + 1
		  from @taraget b
		  join subsystem on b.[Z_PARENT_SUBSYSTEM] = subsystem.[Z_SUBSYSTEM_NAME]
		)
	select
	  [level]
	  ,[root] as z_subsystem
	  ,t1.[id]
	  ,t1.[Z_INDEX_NO]
	  ,t1.[Z_PARENT_SUBSYSTEM]
	  ,t1.[Z_SUBSYSTEM_NAME]
	  ,t1.[Z_IMAGE_FILE]
	  ,f.[filename]
	from subsystem t1
	left join innovator.[FILE] f on t1.[Z_IMAGE_FILE] = f.id
	order by [Z_INDEX_NO]
	END
END]]></sqlserver_body>
  <stale>0</stale>
  <transform_first>0</transform_first>
  <type>procedure</type>
  <name>z_GetSubSystemTreeData</name>
 </Item>
</AML>